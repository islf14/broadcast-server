<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Client</title>
    <script src="/socket.io/socket.io.js"></script>
    <script type="module">
      //
      const $ = (e) => document.querySelector(e)

      const getUsername = () => {
        const username = localStorage.getItem('user_broadcast')
        console.log('getting name: ', username)
        if (username) {
          return username
        }
        modelogin()
        return null
      }

      // S O C K E T //
      const socket = io({
        auth: {
          username: getUsername(),
          countMessages: 0
        }
      })

      socket.on('connect', () => {
        console.log(socket.id) // ojIckSD2jqNzOqIrAGzL
        verifyLogin()
      })

      socket.on('disconnect', () => {
        console.log('*** in disconecct')
      })

      socket.on('return', (msg) => {
        console.log('return: ', msg)
      })

      //  A C T I V E  U S E R S
      socket.on('users', (users) => {
        const username = localStorage.getItem('user_broadcast')
        console.log('username is: ', username)
        if (username === null) {
          logout()
          return
        }
        // if with username exist
        console.log(users)
        const ulusers = document.querySelector('#divusers ul')
        ulusers.innerHTML = ''

        let flogout = true
        users.forEach((element) => {
          if (element.name === username) {
            flogout = false
            const li = document.createElement('li')
            const span = document.createElement('span')
            const button = document.createElement('button')
            span.textContent = username
            button.textContent = 'Logout'
            button.classList.add('btn-logout')
            li.appendChild(span)
            li.appendChild(button)
            ulusers.insertAdjacentElement('afterbegin', li)
            button.addEventListener('click', (e) => {
              e.preventDefault()
              logout()
            })
          } else {
            const li = document.createElement('li')
            const span = document.createElement('span')
            span.textContent = element.name
            li.appendChild(span)
            ulusers.insertAdjacentElement('beforeend', li)
          }
        })
        if (flogout) {
          console.log('..logout, not found')
          logout()
        }
      })

      // FUNCTIONS

      function modelogin() {
        $('#divlogin').style.display = 'block'
        $('#divusers').style.display = 'none'
        $('#chat').style.display = 'none'
      }

      function modechat() {
        $('#divlogin').style.display = 'none'
        $('#divusers').style.display = 'block'
        $('#chat').style.display = 'block'
      }

      //
      function logout() {
        localStorage.removeItem('user_broadcast')
        modelogin()
        socket.emit('user:logout')
      }

      document.querySelector('#send').addEventListener('click', (e) => {
        e.preventDefault()
        console.log('username on send: ', socket.auth.username)
        console.log(socket.auth)
        socket.emit('message', 'holiwi')
      })

      // V E R I F Y  L O G I N
      function verifyLogin() {
        const username = localStorage.getItem('user_broadcast')
        if (username) {
          fetch('/vlogin', {
            method: 'POST',
            headers: {
              'Content-type': 'application/json'
            },
            body: JSON.stringify({ name: username })
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error('Server response error verifying login')
              }
              // successful verify login
              socket.emit('user:getall')
              modechat()
            })
            .catch((error) => {
              console.log('Error: ', error)
              logout()
            })
        } else {
          modelogin()
        }
      }

      //  L O G I N
      document.querySelector('#formlogin').addEventListener('submit', (e) => {
        e.preventDefault()
        const name = $('#name').value.trim()
        $('#name').value = name
        if (name.length < 2 || name.length > 30) {
          e.target.children[1].innerText = 'invalid name'
          e.target.children[1].style.color = 'red'
          return
        }
        e.target.children[1].innerText = ''
        // set in storage because exist emit from server
        localStorage.setItem('user_broadcast', name)
        // login in the db
        fetch('/login', {
          method: 'POST',
          headers: {
            'Content-type': 'application/json'
          },
          body: JSON.stringify({ name: name })
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error('Server response error in login')
            }
            // successful login
            socket.auth.username = name
            socket.emit('user:updatename', name)
            socket.emit('user:getall')
            $('#name').value = ''
            modechat()
          })
          .catch((error) => {
            localStorage.removeItem('user_broadcast')
            e.target.children[1].innerText = 'try another name'
            e.target.children[1].style.color = 'red'
            console.log('Error: ', error)
          })
      })

      //
    </script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      :root {
        color-scheme: light dark;
      }

      body {
        margin: 0;
        padding: 0;
      }

      main {
        display: flex;
        margin: auto;
        max-width: 600px;
        min-width: 300px;
        height: 100vh;
      }

      .principal {
        display: flex;
        justify-content: center;
        width: 100%;
        margin: 1em 0;
      }

      ul {
        list-style-type: none;
        margin: 0;
        padding: 0.5em;
      }

      li {
        margin: 0.3em;
      }

      .users {
        width: 36%;
        margin: 0.8%;
      }

      .formlogin {
        display: grid;
        justify-items: center;
        background-color: rgb(40, 42, 45);
        border: 1px solid;
        border-radius: 0.6em;
        padding: 0.5em;
      }

      button {
        cursor: pointer;
      }

      .formlogin > input {
        width: 100%;
        height: 2em;
        border: 1px solid rgb(0, 110, 255);
        border-radius: 7px;
        outline: none;
        background-color: rgb(50, 40, 40);
      }

      .formlogin > input:valid {
        background-color: rgb(15, 16, 15);
      }

      .formlogin > input:hover {
        border: 1px solid rgb(59, 140, 246);
      }
      .formlogin > input:focus {
        border: 1px solid rgb(91, 159, 243);
      }

      .formlogin > button {
        background-color: rgb(15, 121, 34);
        margin: 4px;
        border: 1px solid white;
        border-radius: 0.5em;
        padding: 6px;
      }

      .formlogin > button:hover {
        background-color: rgb(16, 97, 31);
      }

      .div-show-users {
        height: 100%;
      }

      .listusers {
        border: 1px solid;
        border-radius: 0.6em 0 0 0.6em;
        overflow-y: scroll;
        max-height: 100%;
      }

      .btn-logout {
        background-color: red;
        margin-left: 5px;
      }

      .btn-logout:hover {
        background-color: rgb(195, 1, 1);
      }

      .chat {
        width: 56%;
        margin: 0.8%;
        border: 1px solid;
        border-radius: 0.6em;
        overflow: hidden;
      }

      .messages {
        overflow-y: scroll;
        width: 100%;
        height: 100%;
        margin: auto;
        padding-bottom: 36px;
      }

      .message {
        border: 1px solid rgb(16, 68, 28);
        background-color: rgb(34, 33, 33);
        border-radius: 0.6em;
        padding: 5px;
        max-width: 80%;
      }

      .in {
        justify-self: start;
      }

      .out {
        justify-self: end;
      }

      .message > span {
        font-size: small;
        font-style: italic;
      }

      .message > small {
        font-size: 0.7em;
        display: block;
        justify-self: end;
      }

      .message > p {
        padding: 0;
        margin: 0;
      }

      .formchat {
        position: relative;
        display: flex;
        justify-content: center;
        height: 40px;
        padding: 4px;
        bottom: 40px;
        width: 94%;
      }

      .formchat > input {
        border: 1px solid rgb(22, 245, 234);
        width: 80%;
        border-radius: 1.5em;
        padding: 0 0.9em;
        outline: none;
      }

      .formchat > input:focus {
        border: 1px solid rgb(22, 160, 245);
      }

      .formchat > button {
        width: 20%;
        margin: 0 4px;
        border: 0;
        background-color: rgb(0, 115, 255);
        border-radius: 0.5em;
        overflow: hidden;
      }

      .formchat > button:hover {
        background-color: rgb(22, 88, 168);
      }
    </style>
  </head>
  <body>
    <main>
      <div class="principal">
        <section class="users">
          <div id="divlogin" style="display: block">
            <form id="formlogin" class="formlogin" action="">
              <input
                id="name"
                type="text"
                placeholder="Name"
                autocomplete="off"
                minlength="2"
                maxlength="30"
              />
              <span></span>
              <button type="submit">Enter</button>
            </form>
          </div>
          <div id="divusers" class="div-show-users" style="display: none">
            <ul class="listusers">
              <!-- <li>
                <span>you</span>
                <button class="btn-logout">Logout</button>
              </li>
              <li>
                <span>Chris</span>
              </li> -->
            </ul>
          </div>
        </section>
        <section id="chat" class="chat" style="display: none">
          <ul class="messages">
            <li class="message in">
              <span>Caris Yek</span>
              <p>
                Lorem ipsum dolor sit amet, consectetur adipisicing elit. Amet,
                laboriosam?
              </p>
              <small>15:34</small>
            </li>
            <li class="message in">
              <span>Sandra H</span>
              <p>holiw</p>
              <small>15:34</small>
            </li>
            <li class="message out">
              <span>You</span>
              <p>holiw</p>
              <small>15:34</small>
            </li>
            <li class="message in">
              <span>Juancho</span>
              <p>holiw</p>
              <small>15:23</small>
            </li>
            <li class="message in">
              <span>Juancho</span>
              <p>holiw</p>
              <small>15:23</small>
            </li>
            <li class="message in">
              <span>Juancho</span>
              <p>holiw</p>
              <small>15:23</small>
            </li>
            <li class="message in">
              <span>Juancho</span>
              <p>holiw</p>
              <small>15:23</small>
            </li>
            <li class="message in">
              <span>Juancho</span>
              <p>holiw</p>
              <small>15:23</small>
            </li>
            <li class="message in">
              <span>Juancho</span>
              <p>holiw</p>
              <small>15:23</small>
            </li>
            <li class="message in">
              <span>Juancho</span>
              <p>holiw</p>
              <small>15:23</small>
            </li>

            <li class="message in">
              <span>pablito</span>
              <p>this is the last message</p>
              <small>14:20</small>
            </li>
          </ul>
          <form class="formchat" action="">
            <input
              id="newmessage"
              type="text"
              placeholder="Type a message"
              autocomplete="off"
            />
            <button id="send" type="submit">Send</button>
          </form>
        </section>
      </div>
    </main>
  </body>
</html>
